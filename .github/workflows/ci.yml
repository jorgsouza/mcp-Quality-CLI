name: CI PR

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality-check:
    name: Quality E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Quality MCP
        run: npm run build

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Analyze codebase
        run: |
          node dist/cli.js analyze \
            --repo . \
            --product "mcp-Quality-CLI" \
            --mode analyze \
            --skip-run
        continue-on-error: true

      - name: Validate quality gates
        run: |
          node dist/cli.js validate \
            --repo . \
            --product "mcp-Quality-CLI" \
            --min-mutation 60 \
            --min-branch 70
        continue-on-error: true

      - name: Self-check environment
        run: |
          node dist/cli.js self-check --repo .

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: tests/analyses/
          retention-days: 30

